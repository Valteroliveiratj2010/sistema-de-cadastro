<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final: Gr√°ficos de Vendas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="style.css?v=2.0" rel="stylesheet">
    <style>
        body { padding: 20px; background: #f8f9fa; }
        .test-container { max-width: 1200px; margin: 0 auto; }
        .status-success { color: #059669; font-weight: bold; }
        .status-error { color: #DC2626; font-weight: bold; }
        .status-warning { color: #D97706; font-weight: bold; }
        .chart-container { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>‚úÖ Teste Final: Gr√°ficos de Vendas</h1>
        <p>Verificando se a corre√ß√£o dos gr√°ficos funcionou corretamente.</p>
        
        <div class="alert alert-success">
            <h6>üîß Corre√ß√£o Aplicada:</h6>
            <ul>
                <li><strong>Problema:</strong> API dashboard n√£o retornava dados de vendas</li>
                <li><strong>Solu√ß√£o:</strong> Busca autom√°tica de vendas separadamente</li>
                <li><strong>Fallback:</strong> M√∫ltiplas tentativas de carregamento</li>
                <li><strong>Resultado:</strong> Gr√°ficos devem aparecer com dados reais</li>
            </ul>
        </div>
        
        <div class="chart-container">
            <h4>üìä Gr√°fico de Vendas (Teste)</h4>
            <canvas id="testChart" height="300"></canvas>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="alert alert-info">
                    <h6>üìä Status da API:</h6>
                    <div id="apiStatus">üîÑ Verificando...</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="alert alert-info">
                    <h6>üìà Dados Processados:</h6>
                    <div id="processedData">üîÑ Processando...</div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-secondary">
            <h6>üîç Logs de Execu√ß√£o:</h6>
            <div id="executionLogs">üîÑ Iniciando teste...</div>
        </div>
        
        <div class="mt-4">
            <button class="btn btn-primary" onclick="testarGraficos()">
                üîç Testar Gr√°ficos
            </button>
            <button class="btn btn-success" onclick="abrirDashboard()">
                üìä Abrir Dashboard
            </button>
            <button class="btn btn-warning" onclick="limparCache()">
                üßπ Limpar Cache
            </button>
        </div>
        
        <div class="mt-4">
            <h5>üìã O que foi corrigido:</h5>
            <div class="alert alert-warning">
                <ol>
                    <li><strong>Busca autom√°tica de vendas:</strong> Se a API dashboard n√£o retornar vendas, busca separadamente</li>
                    <li><strong>M√∫ltiplos fallbacks:</strong> Tenta diferentes endpoints e formatos</li>
                    <li><strong>Processamento robusto:</strong> Trata diferentes formatos de data e valor</li>
                    <li><strong>Logs detalhados:</strong> Para facilitar debug</li>
                    <li><strong>Limite aumentado:</strong> Busca at√© 1000 vendas para o gr√°fico</li>
                </ol>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/i18n/i18n.js"></script>
    <script src="js/app.js?v=1.6"></script>
    
    <script>
        let logs = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push({ message: logEntry, type });
            console.log(logEntry);
            updateLogs();
        }
        
        function updateLogs() {
            const container = document.getElementById('executionLogs');
            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            
            logs.forEach(log => {
                const color = log.type === 'error' ? 'red' : log.type === 'success' ? 'green' : log.type === 'warning' ? 'orange' : 'black';
                html += `<div style="color: ${color}; font-family: monospace; font-size: 12px; margin: 2px 0;">${log.message}</div>`;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        async function testarGraficos() {
            addLog('üîç Iniciando teste dos gr√°ficos...', 'info');
            
            try {
                // 1. Testar carregamento do dashboard
                addLog('üåê Testando carregamento do dashboard...', 'info');
                const response = await api.get('/dashboard/stats');
                addLog(`üìä Resposta do dashboard: ${JSON.stringify(response).substring(0, 100)}...`, 'info');
                
                // 2. Verificar se h√° dados de vendas
                let salesData = null;
                if (response && response.sales) {
                    salesData = response.sales;
                    addLog(`‚úÖ Dados de vendas encontrados no dashboard: ${salesData.length} registros`, 'success');
                } else if (response && response.vendas) {
                    salesData = response.vendas;
                    addLog(`‚úÖ Dados de vendas encontrados no dashboard: ${salesData.length} registros`, 'success');
                } else {
                    addLog('‚ö†Ô∏è Nenhum dado de vendas no dashboard, testando busca separada...', 'warning');
                    
                    // 3. Buscar vendas separadamente
                    const salesResponse = await api.get('/sales', { limit: 1000 });
                    if (salesResponse && (salesResponse.sales || salesResponse.data || Array.isArray(salesResponse))) {
                        salesData = salesResponse.sales || salesResponse.data || salesResponse;
                        addLog(`‚úÖ Vendas carregadas separadamente: ${salesData.length} registros`, 'success');
                    } else {
                        addLog('‚ùå Nenhuma venda encontrada na API', 'error');
                        salesData = [];
                    }
                }
                
                // 4. Atualizar status da API
                document.getElementById('apiStatus').innerHTML = `
                    <div class="text-success">‚úÖ API funcionando</div>
                    <div>Dashboard: ${response ? 'OK' : 'ERRO'}</div>
                    <div>Vendas: ${salesData ? salesData.length : 0} registros</div>
                `;
                
                // 5. Processar dados para o gr√°fico
                if (salesData && salesData.length > 0) {
                    addLog('üìà Processando dados para o gr√°fico...', 'info');
                    
                    const currentYear = new Date().getFullYear();
                    const previousYear = currentYear - 1;
                    const salesCurrentYear = new Array(12).fill(0);
                    const salesPreviousYear = new Array(12).fill(0);
                    
                    salesData.forEach((sale, index) => {
                        const saleDate = new Date(sale.date || sale.createdAt || sale.data_venda);
                        const saleYear = saleDate.getFullYear();
                        const saleMonth = saleDate.getMonth();
                        const saleValue = parseFloat(sale.total || sale.valor_total || sale.amount || 0);
                        
                        if (saleYear === currentYear) {
                            salesCurrentYear[saleMonth] += saleValue;
                        } else if (saleYear === previousYear) {
                            salesPreviousYear[saleMonth] += saleValue;
                        }
                    });
                    
                    const totalCurrentYear = salesCurrentYear.reduce((sum, val) => sum + val, 0);
                    const totalPreviousYear = salesPreviousYear.reduce((sum, val) => sum + val, 0);
                    
                    addLog(`üìä Dados processados - Ano atual: R$ ${totalCurrentYear.toFixed(2)}`, 'success');
                    addLog(`üìä Dados processados - Ano anterior: R$ ${totalPreviousYear.toFixed(2)}`, 'success');
                    
                    // 6. Atualizar dados processados
                    document.getElementById('processedData').innerHTML = `
                        <div class="text-success">‚úÖ Dados processados com sucesso</div>
                        <div>Ano ${currentYear}: R$ ${totalCurrentYear.toFixed(2)}</div>
                        <div>Ano ${previousYear}: R$ ${totalPreviousYear.toFixed(2)}</div>
                        <div>Total de vendas: ${salesData.length}</div>
                    `;
                    
                    // 7. Renderizar gr√°fico
                    renderizarGrafico(salesCurrentYear, salesPreviousYear);
                    
                } else {
                    addLog('‚ö†Ô∏è Nenhum dado de venda para processar', 'warning');
                    document.getElementById('processedData').innerHTML = '<div class="text-warning">‚ö†Ô∏è Nenhum dado de venda dispon√≠vel</div>';
                    renderizarGraficoVazio();
                }
                
            } catch (error) {
                addLog(`‚ùå Erro no teste: ${error.message}`, 'error');
                document.getElementById('apiStatus').innerHTML = `<div class="text-danger">‚ùå Erro: ${error.message}</div>`;
            }
        }
        
        function renderizarGrafico(salesCurrentYear, salesPreviousYear) {
            addLog('üìä Renderizando gr√°fico com dados reais...', 'info');
            
            try {
                // Destruir gr√°fico existente
                if (window.testChart) {
                    window.testChart.destroy();
                }
                
                const currentYear = new Date().getFullYear();
                const previousYear = currentYear - 1;
                const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                
                window.testChart = new Chart(document.getElementById('testChart'), {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: `Vendas ${previousYear}`,
                            data: salesPreviousYear,
                            backgroundColor: '#1D4E89',
                            borderColor: '#1D4E89',
                            borderWidth: 2,
                            borderRadius: 8,
                        }, {
                            label: `Vendas ${currentYear}`,
                            data: salesCurrentYear,
                            backgroundColor: '#4A90E2',
                            borderColor: '#4A90E2',
                            borderWidth: 2,
                            borderRadius: 8,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
                
                addLog('‚úÖ Gr√°fico renderizado com sucesso!', 'success');
                
            } catch (error) {
                addLog(`‚ùå Erro ao renderizar gr√°fico: ${error.message}`, 'error');
            }
        }
        
        function renderizarGraficoVazio() {
            addLog('üìä Renderizando gr√°fico vazio...', 'info');
            
            try {
                if (window.testChart) {
                    window.testChart.destroy();
                }
                
                const currentYear = new Date().getFullYear();
                const previousYear = currentYear - 1;
                const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                
                window.testChart = new Chart(document.getElementById('testChart'), {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: `Vendas ${previousYear}`,
                            data: new Array(12).fill(0),
                            backgroundColor: '#1D4E89',
                            borderColor: '#1D4E89',
                            borderWidth: 2,
                            borderRadius: 8,
                        }, {
                            label: `Vendas ${currentYear}`,
                            data: new Array(12).fill(0),
                            backgroundColor: '#4A90E2',
                            borderColor: '#4A90E2',
                            borderWidth: 2,
                            borderRadius: 8,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
                
                addLog('‚úÖ Gr√°fico vazio renderizado', 'success');
                
            } catch (error) {
                addLog(`‚ùå Erro ao renderizar gr√°fico vazio: ${error.message}`, 'error');
            }
        }
        
        function abrirDashboard() {
            window.open('index.html', '_blank');
        }
        
        function limparCache() {
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            alert('Cache limpo! Recarregando p√°gina...');
            location.reload();
        }
        
        // Testar automaticamente ao carregar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(testarGraficos, 1000);
        });
    </script>
</body>
</html> 