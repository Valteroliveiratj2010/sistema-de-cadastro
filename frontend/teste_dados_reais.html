<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste: Dados Reais da API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background: #f8f9fa; }
        .test-container { max-width: 1200px; margin: 0 auto; }
        .success { color: #059669; font-weight: bold; }
        .error { color: #DC2626; font-weight: bold; }
        .warning { color: #D97706; font-weight: bold; }
        .info { color: #2563EB; font-weight: bold; }
        .test-form { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card-status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .card-success { background: #d1fae5; border: 1px solid #10b981; }
        .card-error { background: #fee2e2; border: 1px solid #ef4444; }
        .card-warning { background: #fef3c7; border: 1px solid #f59e0b; }
        .data-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .data-table th { background-color: #f2f2f2; }
        .real-data { background-color: #d1fae5; }
        .example-data { background-color: #fee2e2; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>📊 Teste: Dados Reais da API</h1>
        <p>Verificando se os dados reais da API estão sendo carregados nos cards financeiros.</p>
        
        <div class="alert alert-info">
            <h6>🎯 Objetivo:</h6>
            <ul>
                <li><strong>Remover dados de exemplo:</strong> Não mostrar mais dados fictícios</li>
                <li><strong>Carregar dados reais:</strong> Usar apenas dados da API</li>
                <li><strong>Verificar conectividade:</strong> Confirmar que a API está funcionando</li>
                <li><strong>Validar estrutura:</strong> Verificar se os dados têm a estrutura correta</li>
            </ul>
        </div>
        
        <div class="test-form">
            <h4>🔍 Verificação dos Dados</h4>
            
            <div class="row">
                <div class="col-md-6">
                    <h6>📅 Contas a Receber Vencidas</h6>
                    <div id="overdueReceivableStatus">
                        <div class="card-status card-warning">
                            <strong>Status:</strong> <span id="overdueReceivableStatusText">🔄 Verificando...</span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h6>📅 Contas a Receber Próximas</h6>
                    <div id="upcomingReceivableStatus">
                        <div class="card-status card-warning">
                            <strong>Status:</strong> <span id="upcomingReceivableStatusText">🔄 Verificando...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <h6>💸 Contas a Pagar Vencidas</h6>
                    <div id="overduePayableStatus">
                        <div class="card-status card-warning">
                            <strong>Status:</strong> <span id="overduePayableStatusText">🔄 Verificando...</span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h6>💸 Contas a Pagar Próximas</h6>
                    <div id="upcomingPayableStatus">
                        <div class="card-status card-warning">
                            <strong>Status:</strong> <span id="upcomingPayableStatusText">🔄 Verificando...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <h6>📊 Logs da API:</h6>
                <div id="apiLogs" style="font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px;">
                    Aguardando carregamento...
                </div>
            </div>
            
            <div class="mt-4">
                <h6>📋 Dados Carregados:</h6>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Quantidade</th>
                            <th>Fonte</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable">
                        <tr><td colspan="4">Aguardando dados...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="alert alert-info">
                    <h6>📊 Status Geral:</h6>
                    <div id="generalStatus">🔄 Verificando...</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="alert alert-info">
                    <h6>🎯 Resultado Final:</h6>
                    <div id="finalResult">🔄 Verificando...</div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <button class="btn btn-primary" onclick="testarDadosReais()">
                🧮 Testar Dados Reais
            </button>
            <button class="btn btn-success" onclick="abrirDashboard()">
                📊 Abrir Dashboard
            </button>
            <button class="btn btn-warning" onclick="limparTeste()">
                🧹 Limpar Teste
            </button>
        </div>
        
        <div class="mt-4">
            <h5>🎯 Resultado Esperado:</h5>
            <div class="alert alert-success">
                <ul>
                    <li><strong>Dados Reais:</strong> Todos os cards devem mostrar dados da API</li>
                    <li><strong>Sem Exemplos:</strong> Não deve haver dados fictícios</li>
                    <li><strong>Estrutura Correta:</strong> Dados devem ter cliente, valor e vencimento</li>
                    <li><strong>Conectividade:</strong> API deve responder corretamente</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/app.js?v=3.2"></script>
    
    <script>
        let apiLogs = [];
        
        function adicionarLog(mensagem) {
            apiLogs.push(mensagem);
            const logsDiv = document.getElementById('apiLogs');
            logsDiv.innerHTML = apiLogs.slice(-20).join('<br>');
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function atualizarStatus(cardId, status, tipo = 'warning') {
            const element = document.getElementById(cardId);
            if (element) {
                element.textContent = status;
                element.className = `card-status card-${tipo}`;
            }
        }
        
        async function testarDadosReais() {
            console.log('📊 === TESTE DE DADOS REAIS ===');
            adicionarLog('📊 Iniciando teste de dados reais...');
            
            try {
                // Testar carregamento de dados do dashboard
                adicionarLog('🔄 Carregando dados do dashboard...');
                
                // Simular carregamento dos dados específicos dos cards
                const testData = {};
                
                // Testar vendas vencidas
                adicionarLog('📅 Testando carregamento de vendas vencidas...');
                try {
                    const salesResponse = await api.get('/sales', { limit: 1000 });
                    adicionarLog(`📊 Resposta da API vendas: ${JSON.stringify(salesResponse).substring(0, 200)}...`);
                    
                    if (salesResponse && (salesResponse.sales || salesResponse.data || Array.isArray(salesResponse))) {
                        const sales = salesResponse.sales || salesResponse.data || salesResponse;
                        adicionarLog(`📋 ${sales.length} vendas carregadas da API`);
                        
                        // Aplicar filtro de vendas vencidas
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        const overdueSales = sales.filter(sale => {
                            const dueDate = sale.vencimento || sale.dueDate || sale.dataVencimento || sale.due_date;
                            const status = sale.status || sale.situacao || sale.estado;
                            
                            if (dueDate) {
                                const dueDateObj = new Date(dueDate);
                                dueDateObj.setHours(0, 0, 0, 0);
                                return dueDateObj < today && status !== 'pago' && status !== 'paid' && status !== 'Pago';
                            }
                            return false;
                        });
                        
                        adicionarLog(`✅ ${overdueSales.length} vendas vencidas encontradas na API`);
                        
                        if (overdueSales.length > 0) {
                            atualizarStatus('overdueReceivableStatusText', `✅ ${overdueSales.length} dados reais`, 'success');
                        } else {
                            atualizarStatus('overdueReceivableStatusText', '⚠️ Nenhum dado vencido encontrado', 'warning');
                        }
                        
                        testData.overdueReceivable = overdueSales.length;
                        
                    } else {
                        atualizarStatus('overdueReceivableStatusText', '❌ Erro na resposta da API', 'error');
                        adicionarLog('❌ Resposta inválida da API de vendas');
                    }
                } catch (error) {
                    atualizarStatus('overdueReceivableStatusText', '❌ Erro de conexão', 'error');
                    adicionarLog(`❌ Erro ao carregar vendas: ${error.message}`);
                }
                
                // Testar vendas próximas
                adicionarLog('📅 Testando carregamento de vendas próximas...');
                try {
                    const salesResponse = await api.get('/sales', { limit: 1000 });
                    
                    if (salesResponse && (salesResponse.sales || salesResponse.data || Array.isArray(salesResponse))) {
                        const sales = salesResponse.sales || salesResponse.data || salesResponse;
                        
                        // Aplicar filtro de vendas próximas
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const thirtyDaysFromNow = new Date();
                        thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
                        thirtyDaysFromNow.setHours(23, 59, 59, 999);
                        
                        const upcomingSales = sales.filter(sale => {
                            const dueDate = sale.vencimento || sale.dueDate || sale.dataVencimento || sale.due_date;
                            const status = sale.status || sale.situacao || sale.estado;
                            
                            if (dueDate) {
                                const dueDateObj = new Date(dueDate);
                                dueDateObj.setHours(0, 0, 0, 0);
                                return dueDateObj >= today && dueDateObj <= thirtyDaysFromNow && status !== 'pago' && status !== 'paid' && status !== 'Pago';
                            }
                            return false;
                        });
                        
                        adicionarLog(`✅ ${upcomingSales.length} vendas próximas encontradas na API`);
                        
                        if (upcomingSales.length > 0) {
                            atualizarStatus('upcomingReceivableStatusText', `✅ ${upcomingSales.length} dados reais`, 'success');
                        } else {
                            atualizarStatus('upcomingReceivableStatusText', '⚠️ Nenhum dado próximo encontrado', 'warning');
                        }
                        
                        testData.upcomingReceivable = upcomingSales.length;
                        
                    } else {
                        atualizarStatus('upcomingReceivableStatusText', '❌ Erro na resposta da API', 'error');
                    }
                } catch (error) {
                    atualizarStatus('upcomingReceivableStatusText', '❌ Erro de conexão', 'error');
                    adicionarLog(`❌ Erro ao carregar vendas próximas: ${error.message}`);
                }
                
                // Testar compras vencidas
                adicionarLog('💸 Testando carregamento de compras vencidas...');
                try {
                    const purchasesResponse = await api.get('/purchases', { limit: 1000 });
                    adicionarLog(`📊 Resposta da API compras: ${JSON.stringify(purchasesResponse).substring(0, 200)}...`);
                    
                    if (purchasesResponse && (purchasesResponse.purchases || purchasesResponse.data || Array.isArray(purchasesResponse))) {
                        const purchases = purchasesResponse.purchases || purchasesResponse.data || purchasesResponse;
                        adicionarLog(`📋 ${purchases.length} compras carregadas da API`);
                        
                        // Aplicar filtro de compras vencidas
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        const overduePurchases = purchases.filter(purchase => {
                            const dueDate = purchase.vencimento || purchase.dueDate || purchase.dataVencimento || purchase.due_date;
                            const status = purchase.status || purchase.situacao || purchase.estado;
                            
                            if (dueDate) {
                                const dueDateObj = new Date(dueDate);
                                dueDateObj.setHours(0, 0, 0, 0);
                                return dueDateObj < today && status !== 'pago' && status !== 'paid' && status !== 'Concluída';
                            }
                            return false;
                        });
                        
                        adicionarLog(`✅ ${overduePurchases.length} compras vencidas encontradas na API`);
                        
                        if (overduePurchases.length > 0) {
                            atualizarStatus('overduePayableStatusText', `✅ ${overduePurchases.length} dados reais`, 'success');
                        } else {
                            atualizarStatus('overduePayableStatusText', '⚠️ Nenhum dado vencido encontrado', 'warning');
                        }
                        
                        testData.overduePayable = overduePurchases.length;
                        
                    } else {
                        atualizarStatus('overduePayableStatusText', '❌ Erro na resposta da API', 'error');
                        adicionarLog('❌ Resposta inválida da API de compras');
                    }
                } catch (error) {
                    atualizarStatus('overduePayableStatusText', '❌ Erro de conexão', 'error');
                    adicionarLog(`❌ Erro ao carregar compras: ${error.message}`);
                }
                
                // Testar compras próximas
                adicionarLog('💸 Testando carregamento de compras próximas...');
                try {
                    const purchasesResponse = await api.get('/purchases', { limit: 1000 });
                    
                    if (purchasesResponse && (purchasesResponse.purchases || purchasesResponse.data || Array.isArray(purchasesResponse))) {
                        const purchases = purchasesResponse.purchases || purchasesResponse.data || purchasesResponse;
                        
                        // Aplicar filtro de compras próximas
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const thirtyDaysFromNow = new Date();
                        thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
                        thirtyDaysFromNow.setHours(23, 59, 59, 999);
                        
                        const upcomingPurchases = purchases.filter(purchase => {
                            const dueDate = purchase.vencimento || purchase.dueDate || purchase.dataVencimento || purchase.due_date;
                            const status = purchase.status || purchase.situacao || purchase.estado;
                            
                            if (dueDate) {
                                const dueDateObj = new Date(dueDate);
                                dueDateObj.setHours(0, 0, 0, 0);
                                return dueDateObj >= today && dueDateObj <= thirtyDaysFromNow && status !== 'pago' && status !== 'paid' && status !== 'Concluída';
                            }
                            return false;
                        });
                        
                        adicionarLog(`✅ ${upcomingPurchases.length} compras próximas encontradas na API`);
                        
                        if (upcomingPurchases.length > 0) {
                            atualizarStatus('upcomingPayableStatusText', `✅ ${upcomingPurchases.length} dados reais`, 'success');
                        } else {
                            atualizarStatus('upcomingPayableStatusText', '⚠️ Nenhum dado próximo encontrado', 'warning');
                        }
                        
                        testData.upcomingPayable = upcomingPurchases.length;
                        
                    } else {
                        atualizarStatus('upcomingPayableStatusText', '❌ Erro na resposta da API', 'error');
                    }
                } catch (error) {
                    atualizarStatus('upcomingPayableStatusText', '❌ Erro de conexão', 'error');
                    adicionarLog(`❌ Erro ao carregar compras próximas: ${error.message}`);
                }
                
                // Atualizar tabela de dados
                const tableBody = document.getElementById('dataTable');
                tableBody.innerHTML = '';
                
                const dataTypes = [
                    { name: 'Contas a Receber Vencidas', key: 'overdueReceivable' },
                    { name: 'Contas a Receber Próximas', key: 'upcomingReceivable' },
                    { name: 'Contas a Pagar Vencidas', key: 'overduePayable' },
                    { name: 'Contas a Pagar Próximas', key: 'upcomingPayable' }
                ];
                
                dataTypes.forEach(type => {
                    const row = document.createElement('tr');
                    const count = testData[type.key] || 0;
                    const isRealData = count > 0;
                    const rowClass = isRealData ? 'real-data' : 'example-data';
                    
                    row.className = rowClass;
                    row.innerHTML = `
                        <td>${type.name}</td>
                        <td>${count}</td>
                        <td>${isRealData ? 'API Real' : 'Nenhum dado'}</td>
                        <td>${isRealData ? '✅ Dados reais' : '⚠️ Sem dados'}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Atualizar status geral
                const successCount = document.querySelectorAll('.card-success').length;
                const totalCount = document.querySelectorAll('.card-status').length;
                const hasRealData = Object.values(testData).some(count => count > 0);
                
                document.getElementById('generalStatus').innerHTML = `
                    <div class="${hasRealData ? 'success' : 'warning'}">${hasRealData ? '✅' : '⚠️'} Teste concluído</div>
                    <div><strong>APIs funcionando:</strong> ${successCount}/${totalCount}</div>
                    <div><strong>Dados reais encontrados:</strong> ${hasRealData ? '✅' : '❌'}</div>
                `;
                
                if (hasRealData) {
                    document.getElementById('finalResult').innerHTML = `
                        <div class="success">🎉 DADOS REAIS CARREGADOS!</div>
                        <div><strong>Status:</strong> API funcionando corretamente</div>
                        <div><strong>Próximo passo:</strong> Verificar no dashboard</div>
                    `;
                    adicionarLog('🎉 Dados reais carregados com sucesso!');
                } else {
                    document.getElementById('finalResult').innerHTML = `
                        <div class="warning">⚠️ NENHUM DADO REAL ENCONTRADO</div>
                        <div><strong>Status:</strong> Verificar se há dados na API</div>
                        <div><strong>Sugestão:</strong> Criar alguns registros de teste</div>
                    `;
                    adicionarLog('⚠️ Nenhum dado real encontrado na API');
                }
                
                adicionarLog('✅ Teste de dados reais concluído');
                
            } catch (error) {
                console.error('❌ Erro no teste de dados reais:', error);
                adicionarLog(`❌ Erro no teste: ${error.message}`);
                
                document.getElementById('generalStatus').innerHTML = `
                    <div class="error">❌ Erro no teste</div>
                    <div><strong>Erro:</strong> ${error.message}</div>
                `;
            }
        }
        
        function limparTeste() {
            apiLogs = [];
            document.getElementById('apiLogs').innerHTML = 'Aguardando carregamento...';
            document.getElementById('dataTable').innerHTML = '<tr><td colspan="4">Aguardando dados...</td></tr>';
            
            // Resetar status dos cards
            const statusElements = [
                'overdueReceivableStatusText', 'upcomingReceivableStatusText',
                'overduePayableStatusText', 'upcomingPayableStatusText'
            ];
            
            statusElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = '🔄 Verificando...';
                    element.className = 'card-status card-warning';
                }
            });
            
            document.getElementById('generalStatus').innerHTML = '<div>🔄 Teste limpo</div>';
            document.getElementById('finalResult').innerHTML = '<div>🔄 Teste limpo</div>';
        }
        
        function abrirDashboard() {
            window.open('index.html', '_blank');
        }
        
        // Configurar eventos
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Página carregada, iniciando teste de dados reais...');
            adicionarLog('🚀 Página carregada, iniciando teste de dados reais...');
            
            // Executar teste automático após 2 segundos
            setTimeout(() => {
                testarDadosReais();
            }, 2000);
        });
    </script>
</body>
</html> 