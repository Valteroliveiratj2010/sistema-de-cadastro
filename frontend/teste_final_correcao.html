<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final: Corre√ß√£o do Formato salesByMonth</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background: #f8f9fa; }
        .test-container { max-width: 1200px; margin: 0 auto; }
        .log-success { color: #059669; font-weight: bold; }
        .log-error { color: #DC2626; font-weight: bold; }
        .log-warning { color: #D97706; font-weight: bold; }
        .log-info { color: #2563EB; font-weight: bold; }
        .chart-test { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>‚úÖ Teste Final: Corre√ß√£o do Formato salesByMonth</h1>
        <p>Verificando se a corre√ß√£o do formato de dados funcionou.</p>
        
        <div class="alert alert-success">
            <h6>üîß Problema Identificado e Corrigido:</h6>
            <ul>
                <li><strong>Problema:</strong> API retorna dados no formato salesByMonth</li>
                <li><strong>Formato:</strong> {month: '2024-08', total: 1500, count: 1, averageTicket: 1500}</li>
                <li><strong>Erro:</strong> Fun√ß√£o tentava processar como vendas individuais</li>
                <li><strong>Solu√ß√£o:</strong> Detec√ß√£o autom√°tica do formato e processamento correto</li>
            </ul>
        </div>
        
        <div class="chart-test">
            <h4>üìä Gr√°fico de Teste</h4>
            <canvas id="testChart" height="300"></canvas>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="alert alert-info">
                    <h6>üìä Dados da API:</h6>
                    <div id="apiData">üîÑ Verificando...</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="alert alert-info">
                    <h6>üìà Dados Processados:</h6>
                    <div id="processedData">üîÑ Processando...</div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-secondary">
            <h6>üîç Logs de Console:</h6>
            <div id="consoleInfo">
                <p>Abra o DevTools (F12) e v√° para a aba Console para ver os logs detalhados.</p>
                <p>Procure por: "üìä Detectado formato salesByMonth, processando..."</p>
            </div>
        </div>
        
        <div class="mt-4">
            <button class="btn btn-primary" onclick="testarCorrecao()">
                üîç Testar Corre√ß√£o
            </button>
            <button class="btn btn-success" onclick="abrirDashboard()">
                üìä Abrir Dashboard
            </button>
            <button class="btn btn-warning" onclick="limparCache()">
                üßπ Limpar Cache
            </button>
        </div>
        
        <div class="mt-4">
            <h5>üìã O que foi corrigido:</h5>
            <div class="alert alert-warning">
                <ol>
                    <li><strong>Detec√ß√£o autom√°tica:</strong> Verifica se os dados t√™m propriedade 'month'</li>
                    <li><strong>Processamento correto:</strong> Extrai ano e m√™s do formato '2024-08'</li>
                    <li><strong>Convers√£o de m√™s:</strong> Converte de 1-12 para 0-11 (JavaScript)</li>
                    <li><strong>Valores corretos:</strong> Usa o campo 'total' para valores</li>
                    <li><strong>Logs detalhados:</strong> Mostra o processamento passo a passo</li>
                </ol>
            </div>
        </div>
        
        <div class="mt-4">
            <h5>üéØ Resultado Esperado:</h5>
            <div class="alert alert-success">
                <ul>
                    <li><strong>Gr√°fico com dados:</strong> Barras mostrando valores reais</li>
                    <li><strong>Logs corretos:</strong> "‚úÖ Adicionado ao ano atual/anterior"</li>
                    <li><strong>Totais corretos:</strong> Somas por ano diferentes de zero</li>
                    <li><strong>Meses corretos:</strong> Dados distribu√≠dos nos meses certos</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/i18n/i18n.js"></script>
    <script src="js/app.js?v=1.8"></script>
    
    <script>
        async function testarCorrecao() {
            console.log('üîç === TESTE DA CORRE√á√ÉO ===');
            
            try {
                // 1. Buscar dados reais da API
                console.log('üåê Buscando dados da API...');
                const response = await api.get('/dashboard/stats');
                console.log('üìä Resposta da API:', response);
                
                // 2. Verificar se h√° dados salesByMonth
                let salesData = null;
                if (response && response.salesByMonth) {
                    salesData = response.salesByMonth;
                    console.log(`‚úÖ Dados salesByMonth encontrados: ${salesData.length} registros`);
                } else {
                    console.log('‚ö†Ô∏è Nenhum dado salesByMonth encontrado');
                    salesData = [];
                }
                
                // 3. Mostrar dados da API
                document.getElementById('apiData').innerHTML = `
                    <div class="text-success">‚úÖ API funcionando</div>
                    <div><strong>Dados salesByMonth:</strong> ${salesData.length} registros</div>
                    <div><strong>Primeiro registro:</strong> ${salesData.length > 0 ? JSON.stringify(salesData[0]) : 'N/A'}</div>
                `;
                
                // 4. Testar processamento manual
                if (salesData.length > 0) {
                    console.log('üìà Testando processamento manual...');
                    
                    const currentYear = new Date().getFullYear();
                    const previousYear = currentYear - 1;
                    const salesCurrentYear = new Array(12).fill(0);
                    const salesPreviousYear = new Array(12).fill(0);
                    
                    salesData.forEach((item, index) => {
                        console.log(`üì¶ Processando item ${index + 1}:`, item);
                        
                        if (item.month) {
                            const monthParts = item.month.split('-');
                            if (monthParts.length === 2) {
                                const saleYear = parseInt(monthParts[0]);
                                const saleMonth = parseInt(monthParts[1]) - 1;
                                const saleValue = parseFloat(item.total || 0);
                                
                                console.log(`   üìÖ M√™s: ${item.month}, Ano: ${saleYear}, M√™s (0-11): ${saleMonth}, Valor: ${saleValue}`);
                                
                                if (saleYear === currentYear) {
                                    salesCurrentYear[saleMonth] += saleValue;
                                    console.log(`   ‚úÖ Adicionado ao ano atual (m√™s ${saleMonth}): ${saleValue}`);
                                } else if (saleYear === previousYear) {
                                    salesPreviousYear[saleMonth] += saleValue;
                                    console.log(`   ‚úÖ Adicionado ao ano anterior (m√™s ${saleMonth}): ${saleValue}`);
                                }
                            }
                        }
                    });
                    
                    const totalCurrentYear = salesCurrentYear.reduce((sum, val) => sum + val, 0);
                    const totalPreviousYear = salesPreviousYear.reduce((sum, val) => sum + val, 0);
                    
                    console.log(`üìä Totais processados: Ano atual R$ ${totalCurrentYear.toFixed(2)}, Ano anterior R$ ${totalPreviousYear.toFixed(2)}`);
                    
                    // 5. Mostrar dados processados
                    document.getElementById('processedData').innerHTML = `
                        <div class="text-success">‚úÖ Dados processados com sucesso</div>
                        <div><strong>Ano ${currentYear}:</strong> R$ ${totalCurrentYear.toFixed(2)}</div>
                        <div><strong>Ano ${previousYear}:</strong> R$ ${totalPreviousYear.toFixed(2)}</div>
                        <div><strong>Dados por m√™s (atual):</strong> ${salesCurrentYear.join(', ')}</div>
                    `;
                    
                    // 6. Renderizar gr√°fico de teste
                    renderizarGraficoTeste(salesCurrentYear, salesPreviousYear);
                    
                } else {
                    document.getElementById('processedData').innerHTML = '<div class="text-warning">‚ö†Ô∏è Nenhum dado para processar</div>';
                }
                
            } catch (error) {
                console.error('‚ùå Erro no teste:', error);
                document.getElementById('apiData').innerHTML = `<div class="text-danger">‚ùå Erro: ${error.message}</div>`;
            }
        }
        
        function renderizarGraficoTeste(salesCurrentYear, salesPreviousYear) {
            console.log('üìä Renderizando gr√°fico de teste...');
            
            try {
                // Destruir gr√°fico existente
                if (window.testChart) {
                    window.testChart.destroy();
                }
                
                const currentYear = new Date().getFullYear();
                const previousYear = currentYear - 1;
                const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                
                window.testChart = new Chart(document.getElementById('testChart'), {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: `Vendas ${previousYear} (Corrigido)`,
                            data: salesPreviousYear,
                            backgroundColor: '#DC2626',
                            borderColor: '#DC2626',
                            borderWidth: 2,
                            borderRadius: 8,
                        }, {
                            label: `Vendas ${currentYear} (Corrigido)`,
                            data: salesCurrentYear,
                            backgroundColor: '#059669',
                            borderColor: '#059669',
                            borderWidth: 2,
                            borderRadius: 8,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico de teste renderizado com sucesso!');
                
            } catch (error) {
                console.error('‚ùå Erro ao renderizar gr√°fico de teste:', error);
            }
        }
        
        function abrirDashboard() {
            window.open('index.html', '_blank');
        }
        
        function limparCache() {
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            alert('Cache limpo! Recarregando p√°gina...');
            location.reload();
        }
        
        // Teste autom√°tico ao carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ P√°gina carregada, aguardando 2 segundos...');
            setTimeout(testarCorrecao, 2000);
        });
    </script>
</body>
</html> 