<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste: Valores Reais no Eixo Y</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background: #f8f9fa; }
        .test-container { max-width: 1200px; margin: 0 auto; }
        .chart-test { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { color: #059669; font-weight: bold; }
        .error { color: #DC2626; font-weight: bold; }
        .warning { color: #D97706; font-weight: bold; }
        .info { color: #2563EB; font-weight: bold; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>‚úÖ Teste: Valores Reais no Eixo Y</h1>
        <p>Verificando se o eixo Y mostra apenas os valores reais das vendas com formata√ß√£o de moeda correta.</p>
        
        <div class="alert alert-success">
            <h6>üîß Problema Corrigido:</h6>
            <ul>
                <li><strong>Problema:</strong> Eixo Y mostrava valores fict√≠cios (0‚Ç¨ at√© 1600‚Ç¨)</li>
                <li><strong>Dados reais:</strong> Apenas 2 vendas: R$ 1.500,00 e R$ 400,00</li>
                <li><strong>Solu√ß√£o:</strong> Eixo Y baseado nos dados reais + formata√ß√£o de moeda</li>
                <li><strong>Resultado esperado:</strong> Eixo Y mostra: 0, R$ 400, R$ 800, R$ 1200, R$ 1800</li>
            </ul>
        </div>
        
        <div class="chart-test">
            <h4>üìä Gr√°fico com Valores Reais</h4>
            <canvas id="salesChart" height="300"></canvas>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="alert alert-info">
                    <h6>üìä Dados Reais da API:</h6>
                    <div id="apiData">üîÑ Verificando...</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="alert alert-info">
                    <h6>üìà Configura√ß√£o do Eixo Y:</h6>
                    <div id="yAxisConfig">üîÑ Verificando...</div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-secondary">
            <h6>üîç O que foi alterado:</h6>
            <div class="code-block" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace;">
                <div><strong>Adicionado:</strong></div>
                <div>suggestedMax: Math.max(...salesCurrentYear, ...salesPreviousYear) * 1.2</div>
                <br>
                <div><strong>Mantido:</strong></div>
                <div>callback: function(value) {</div>
                <div>  if (window.i18n) {</div>
                <div>    return window.i18n.formatCurrency(value);</div>
                <div>  }</div>
                <div>  return 'R$ ' + value.toFixed(0);</div>
                <div>}</div>
            </div>
        </div>
        
        <div class="mt-4">
            <button class="btn btn-primary" onclick="testarValoresReais()">
                üîç Testar Valores Reais
            </button>
            <button class="btn btn-success" onclick="abrirDashboard()">
                üìä Abrir Dashboard
            </button>
            <button class="btn btn-warning" onclick="testarIdiomas()">
                üåç Testar Idiomas
            </button>
            <button class="btn btn-info" onclick="limparCache()">
                üßπ Limpar Cache
            </button>
        </div>
        
        <div class="mt-4">
            <h5>üéØ Resultado Esperado:</h5>
            <div class="alert alert-success">
                <ul>
                    <li><strong>Valores reais:</strong> Eixo Y baseado em R$ 1.500 (m√°ximo real)</li>
                    <li><strong>Formata√ß√£o correta:</strong> R$ 0, R$ 400, R$ 800, R$ 1200, R$ 1800</li>
                    <li><strong>Internacionaliza√ß√£o:</strong> ‚Ç¨ para espanhol, $ para ingl√™s</li>
                    <li><strong>Barras vis√≠veis:</strong> Julho ~1500, Agosto ~400</li>
                </ul>
            </div>
        </div>
        
        <div class="mt-4">
            <h5>üìã Checklist de Verifica√ß√£o:</h5>
            <div class="alert alert-warning">
                <div id="checklist">
                    <div>üîÑ Verificando...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/i18n/i18n.js"></script>
    <script src="js/app.js?v=2.1"></script>
    
    <script>
        let testResults = {
            apiWorking: false,
            chartRendered: false,
            yAxisCorrect: false,
            currencyFormatting: false
        };
        
        async function testarValoresReais() {
            console.log('üîç === TESTE DE VALORES REAIS ===');
            
            try {
                // 1. Verificar API
                console.log('üåê Testando API...');
                const response = await api.get('/dashboard/stats');
                console.log('üìä Resposta da API:', response);
                
                if (response && response.salesByMonth) {
                    const salesData = response.salesByMonth;
                    const valuesWithData = salesData.filter(item => item.total > 0);
                    const maxValue = Math.max(...valuesWithData.map(item => item.total));
                    
                    testResults.apiWorking = true;
                    document.getElementById('apiData').innerHTML = `
                        <div class="success">‚úÖ API funcionando</div>
                        <div><strong>Total de registros:</strong> ${salesData.length}</div>
                        <div><strong>Registros com dados:</strong> ${valuesWithData.length}</div>
                        <div><strong>Valor m√°ximo real:</strong> R$ ${maxValue.toFixed(2)}</div>
                        <div><strong>Valores reais:</strong></div>
                        ${valuesWithData.map(item => `<div>‚Ä¢ ${item.month}: R$ ${item.total.toFixed(2)}</div>`).join('')}
                    `;
                } else {
                    document.getElementById('apiData').innerHTML = '<div class="error">‚ùå Nenhum dado encontrado</div>';
                }
                
                // 2. Aguardar renderiza√ß√£o e verificar eixo Y
                setTimeout(() => {
                    verificarEixoY();
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Erro no teste:', error);
                document.getElementById('apiData').innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        }
        
        function verificarEixoY() {
            console.log('üîç Verificando eixo Y...');
            
            const canvas = document.getElementById('salesChart');
            if (!canvas) {
                document.getElementById('yAxisConfig').innerHTML = '<div class="error">‚ùå Canvas n√£o encontrado</div>';
                return;
            }
            
            const chart = Chart.getChart(canvas);
            if (chart && chart.options && chart.options.scales && chart.options.scales.y) {
                const yAxis = chart.options.scales.y;
                
                testResults.chartRendered = true;
                
                // Verificar suggestedMax
                if (yAxis.suggestedMax) {
                    console.log('üìä suggestedMax configurado:', yAxis.suggestedMax);
                    testResults.yAxisCorrect = true;
                }
                
                // Verificar formata√ß√£o de moeda
                if (yAxis.ticks && yAxis.ticks.callback) {
                    const testValues = [0, 400, 800, 1200, 1800];
                    const formattedValues = testValues.map(value => yAxis.ticks.callback(value));
                    
                    console.log('üìä Valores formatados do eixo Y:', formattedValues);
                    
                    // Verificar se tem formata√ß√£o de moeda
                    const hasCurrencyFormatting = formattedValues.some(value => 
                        value.includes('R$') || value.includes('‚Ç¨') || value.includes('$')
                    );
                    
                    if (hasCurrencyFormatting) {
                        testResults.currencyFormatting = true;
                    }
                    
                    document.getElementById('yAxisConfig').innerHTML = `
                        <div class="success">‚úÖ Eixo Y configurado</div>
                        <div><strong>suggestedMax:</strong> ${yAxis.suggestedMax ? 'Configurado' : 'N√£o configurado'}</div>
                        <div><strong>Formata√ß√£o de moeda:</strong> ${hasCurrencyFormatting ? 'Sim' : 'N√£o'}</div>
                        <div><strong>Valores de exemplo:</strong> ${formattedValues.join(', ')}</div>
                    `;
                }
                
                atualizarChecklist();
            } else {
                document.getElementById('yAxisConfig').innerHTML = '<div class="error">‚ùå Configura√ß√£o do eixo Y n√£o encontrada</div>';
            }
        }
        
        function testarIdiomas() {
            console.log('üåç Testando mudan√ßa de idiomas...');
            
            if (window.i18n) {
                const languages = ['pt', 'en', 'es'];
                let currentIndex = 0;
                
                const testNextLanguage = () => {
                    if (currentIndex < languages.length) {
                        const lang = languages[currentIndex];
                        console.log(`üîÑ Testando idioma: ${lang}`);
                        window.i18n.setLanguage(lang);
                        
                        setTimeout(() => {
                            verificarEixoY();
                            currentIndex++;
                            testNextLanguage();
                        }, 1000);
                    }
                };
                
                testNextLanguage();
            }
        }
        
        function atualizarChecklist() {
            const checklist = document.getElementById('checklist');
            checklist.innerHTML = `
                <div class="${testResults.apiWorking ? 'success' : 'error'}">
                    ${testResults.apiWorking ? '‚úÖ' : '‚ùå'} API funcionando
                </div>
                <div class="${testResults.chartRendered ? 'success' : 'error'}">
                    ${testResults.chartRendered ? '‚úÖ' : '‚ùå'} Gr√°fico renderizado
                </div>
                <div class="${testResults.yAxisCorrect ? 'success' : 'error'}">
                    ${testResults.yAxisCorrect ? '‚úÖ' : '‚ùå'} Eixo Y baseado em dados reais
                </div>
                <div class="${testResults.currencyFormatting ? 'success' : 'error'}">
                    ${testResults.currencyFormatting ? '‚úÖ' : '‚ùå'} Formata√ß√£o de moeda
                </div>
            `;
        }
        
        function abrirDashboard() {
            window.open('index.html', '_blank');
        }
        
        function limparCache() {
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            alert('Cache limpo! Recarregando p√°gina...');
            location.reload();
        }
        
        // Teste autom√°tico ao carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ P√°gina carregada, iniciando teste de valores reais...');
            setTimeout(testarValoresReais, 1000);
        });
    </script>
</body>
</html> 