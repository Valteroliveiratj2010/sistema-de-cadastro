<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste: Total Din√¢mico da Venda</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background: #f8f9fa; }
        .test-container { max-width: 1200px; margin: 0 auto; }
        .success { color: #059669; font-weight: bold; }
        .error { color: #DC2626; font-weight: bold; }
        .warning { color: #D97706; font-weight: bold; }
        .info { color: #2563EB; font-weight: bold; }
        .test-form { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>‚úÖ Teste: Total Din√¢mico da Venda</h1>
        <p>Verificando se o valor total da venda √© atualizado dinamicamente quando produtos s√£o adicionados.</p>
        
        <div class="alert alert-success">
            <h6>üîß Problema Corrigido:</h6>
            <ul>
                <li><strong>Problema:</strong> Campo "Valor Total da Venda" mostrava "R$ 0,00"</li>
                <li><strong>Dados reais:</strong> Cimento - Qtd: 1 x R$ 40,00 = R$ 40,00</li>
                <li><strong>Solu√ß√£o:</strong> Estrutura HTML corrigida + fun√ß√£o updateSaleTotal</li>
                <li><strong>Resultado esperado:</strong> "R$ 40,00" (atualizado dinamicamente)</li>
            </ul>
        </div>
        
        <div class="test-form">
            <h4>üõí Simulador de Venda</h4>
            
            <div class="row">
                <div class="col-md-6">
                    <h6>üì¶ Produtos da Venda:</h6>
                    <div id="saleProductsList" class="list-group mb-3">
                        <p class="text-muted text-center m-0">Nenhum produto adicionado.</p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Produto:</label>
                        <select id="productSelect" class="form-select">
                            <option value="">Selecione um produto</option>
                            <option value="cimento" data-price="40.00">Cimento - R$ 40,00</option>
                            <option value="areia" data-price="25.00">Areia - R$ 25,00</option>
                            <option value="tijolo" data-price="0.50">Tijolo - R$ 0,50</option>
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Quantidade:</label>
                            <input type="number" id="productQuantity" class="form-control" value="1" min="1">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Pre√ßo Unit.:</label>
                            <input type="number" id="productUnitPrice" class="form-control" step="0.01" readonly>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary mt-3" onclick="adicionarProdutoTeste()">
                        ‚ûï Adicionar Produto
                    </button>
                </div>
                
                <div class="col-md-6">
                    <h6>üí∞ Resumo da Venda:</h6>
                    <div class="alert alert-info">
                        <strong>Valor Total da Venda:</strong>
                        <div id="saleTotalValueDisplay" class="fw-bold fs-4">R$ 0,00</div>
                    </div>
                    
                    <div class="alert alert-secondary">
                        <h6>üîç Logs de Atualiza√ß√£o:</h6>
                        <div id="updateLogs" style="font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
                            Aguardando produtos...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="alert alert-info">
                    <h6>üìä Status da Atualiza√ß√£o:</h6>
                    <div id="updateStatus">üîÑ Verificando...</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="alert alert-info">
                    <h6>üéØ Teste Autom√°tico:</h6>
                    <div id="autoTest">üîÑ Verificando...</div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <button class="btn btn-primary" onclick="testarAtualizacao()">
                üßÆ Testar Atualiza√ß√£o
            </button>
            <button class="btn btn-success" onclick="abrirDashboard()">
                üìä Abrir Dashboard
            </button>
            <button class="btn btn-warning" onclick="limparTeste()">
                üßπ Limpar Teste
            </button>
            <button class="btn btn-info" onclick="limparCache()">
                üßπ Limpar Cache
            </button>
        </div>
        
        <div class="mt-4">
            <h5>üéØ Resultado Esperado:</h5>
            <div class="alert alert-success">
                <ul>
                    <li><strong>Adicionar produto:</strong> Total deve mudar de R$ 0,00 para R$ 40,00</li>
                    <li><strong>Adicionar mais produtos:</strong> Total deve somar corretamente</li>
                    <li><strong>Remover produtos:</strong> Total deve diminuir corretamente</li>
                    <li><strong>Atualiza√ß√£o autom√°tica:</strong> Sem necessidade de refresh</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="js/app.js?v=2.4"></script>
    
    <script>
        let testProducts = [];
        let updateLogs = [];
        
        function adicionarProdutoTeste() {
            const productSelect = document.getElementById('productSelect');
            const quantityInput = document.getElementById('productQuantity');
            const priceInput = document.getElementById('productUnitPrice');
            
            if (!productSelect.value) {
                alert('Selecione um produto');
                return;
            }
            
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const productId = productSelect.value;
            const productName = selectedOption.textContent.split(' - ')[0];
            const quantity = parseInt(quantityInput.value);
            const price = parseFloat(priceInput.value);
            const total = quantity * price;
            
            const product = {
                id: productId,
                name: productName,
                quantity: quantity,
                price: price,
                total: total
            };
            
            testProducts.push(product);
            renderizarProdutosTeste();
            calcularTotalTeste();
            
            // Limpar campos
            productSelect.value = '';
            quantityInput.value = '1';
            priceInput.value = '';
            
            adicionarLog(`‚ûï Produto adicionado: ${productName} - R$ ${total.toFixed(2)}`);
        }
        
        function renderizarProdutosTeste() {
            const productsList = document.getElementById('saleProductsList');
            productsList.innerHTML = '';
            
            testProducts.forEach((product, index) => {
                const productElement = document.createElement('div');
                productElement.className = 'list-group-item d-flex justify-content-between align-items-center';
                productElement.dataset.productId = product.id;
                
                productElement.innerHTML = `
                    <div>
                        <strong>${product.name}</strong>
                        <br>
                        <small>Qtd: ${product.quantity} x R$ ${product.price.toFixed(2).replace('.', ',')}</small>
                    </div>
                    <div>
                        <span class="badge bg-primary rounded-pill">R$ ${product.total.toFixed(2).replace('.', ',')}</span>
                        <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removerProdutoTeste(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                
                productsList.appendChild(productElement);
            });
            
            if (testProducts.length === 0) {
                productsList.innerHTML = '<p class="text-muted text-center m-0">Nenhum produto adicionado.</p>';
            }
        }
        
        function removerProdutoTeste(index) {
            const product = testProducts[index];
            testProducts.splice(index, 1);
            renderizarProdutosTeste();
            calcularTotalTeste();
            
            adicionarLog(`üóëÔ∏è Produto removido: ${product.name} - R$ ${product.total.toFixed(2)}`);
        }
        
        function calcularTotalTeste() {
            console.log('üßÆ === TESTE DE ATUALIZA√á√ÉO DIN√ÇMICA ===');
            
            const totalDisplay = document.getElementById('saleTotalValueDisplay');
            const logsDiv = document.getElementById('updateLogs');
            
            let total = 0;
            
            console.log(`üì¶ Encontrados ${testProducts.length} produtos na lista`);
            adicionarLog(`üì¶ Encontrados ${testProducts.length} produtos na lista`);
            
            testProducts.forEach((product, index) => {
                console.log(`üìä Produto ${index + 1}: ${product.name} - R$ ${product.total.toFixed(2)}`);
                adicionarLog(`üìä Produto ${index + 1}: ${product.name} - R$ ${product.total.toFixed(2)}`);
                
                total += product.total;
                console.log(`‚úÖ Valor do produto ${index + 1}: R$ ${product.total.toFixed(2)}`);
                adicionarLog(`‚úÖ Valor do produto ${index + 1}: R$ ${product.total.toFixed(2)}`);
            });
            
            console.log(`üí∞ Total calculado: R$ ${total.toFixed(2)}`);
            adicionarLog(`üí∞ Total calculado: R$ ${total.toFixed(2)}`);
            
            // Atualizar display do total
            if (window.i18n) {
                totalDisplay.textContent = window.i18n.formatCurrency(total);
            } else {
                totalDisplay.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            }
            
            console.log(`‚úÖ Total atualizado: ${totalDisplay.textContent}`);
            adicionarLog(`‚úÖ Total atualizado: ${totalDisplay.textContent}`);
            
            // Verificar se a atualiza√ß√£o funcionou
            const expectedTotal = testProducts.reduce((sum, p) => sum + p.total, 0);
            const actualTotal = parseFloat(totalDisplay.textContent.replace(/[^\d,]/g, '').replace(',', '.'));
            
            if (Math.abs(actualTotal - expectedTotal) < 0.01) {
                document.getElementById('updateStatus').innerHTML = `
                    <div class="success">‚úÖ Atualiza√ß√£o funcionando</div>
                    <div><strong>Total esperado:</strong> R$ ${expectedTotal.toFixed(2)}</div>
                    <div><strong>Total atual:</strong> ${totalDisplay.textContent}</div>
                `;
            } else {
                document.getElementById('updateStatus').innerHTML = `
                    <div class="error">‚ùå Erro na atualiza√ß√£o</div>
                    <div><strong>Total esperado:</strong> R$ ${expectedTotal.toFixed(2)}</div>
                    <div><strong>Total atual:</strong> ${totalDisplay.textContent}</div>
                `;
            }
        }
        
        function adicionarLog(mensagem) {
            updateLogs.push(`[${new Date().toLocaleTimeString()}] ${mensagem}`);
            const logsDiv = document.getElementById('updateLogs');
            logsDiv.innerHTML = updateLogs.slice(-10).join('<br>');
        }
        
        function testarAtualizacao() {
            console.log('üßÆ === TESTE AUTOM√ÅTICO ===');
            
            // Limpar produtos existentes
            testProducts = [];
            updateLogs = [];
            
            adicionarLog('üßÆ Iniciando teste autom√°tico...');
            
            // Adicionar produto de teste (Cimento - 1 x R$ 40,00)
            testProducts.push({
                id: 'cimento',
                name: 'Cimento',
                quantity: 1,
                price: 40.00,
                total: 40.00
            });
            
            renderizarProdutosTeste();
            calcularTotalTeste();
            
            document.getElementById('autoTest').innerHTML = `
                <div class="success">‚úÖ Teste autom√°tico executado</div>
                <div><strong>Produto:</strong> Cimento - 1 x R$ 40,00</div>
                <div><strong>Total esperado:</strong> R$ 40,00</div>
                <div><strong>Total calculado:</strong> <span id="autoTestResult">Verificando...</span></div>
            `;
            
            setTimeout(() => {
                const result = document.getElementById('saleTotalValueDisplay').textContent;
                document.getElementById('autoTestResult').textContent = result;
                
                if (result === 'R$ 40,00' || result.includes('40,00')) {
                    document.getElementById('autoTestResult').className = 'success';
                } else {
                    document.getElementById('autoTestResult').className = 'error';
                }
            }, 100);
        }
        
        function limparTeste() {
            testProducts = [];
            updateLogs = [];
            renderizarProdutosTeste();
            calcularTotalTeste();
            document.getElementById('updateStatus').innerHTML = '<div>üîÑ Teste limpo</div>';
            document.getElementById('autoTest').innerHTML = '<div>üîÑ Teste limpo</div>';
        }
        
        function abrirDashboard() {
            window.open('index.html', '_blank');
        }
        
        function limparCache() {
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            alert('Cache limpo! Recarregando p√°gina...');
            location.reload();
        }
        
        // Configurar eventos
        document.addEventListener('DOMContentLoaded', function() {
            // Atualizar pre√ßo quando produto for selecionado
            const productSelect = document.getElementById('productSelect');
            const priceInput = document.getElementById('productUnitPrice');
            
            productSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption && selectedOption.dataset.price) {
                    priceInput.value = selectedOption.dataset.price;
                } else {
                    priceInput.value = '';
                }
            });
            
            console.log('üöÄ P√°gina carregada, iniciando teste de atualiza√ß√£o din√¢mica...');
            adicionarLog('üöÄ P√°gina carregada, iniciando teste...');
        });
    </script>
</body>
</html> 